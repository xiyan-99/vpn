# Cydia源全量监控 Surge 面板

## 功能介绍

这是一个专为iOS越狱用户设计的**源级别**监控模块，与单包监控不同，它可以：

- ✅ 监控整个源的**所有包**变化
- ✅ 检测**新增**的包
- ✅ 检测**更新**的包（版本升级）
- ✅ 检测**降级**的包（版本回退）
- ✅ 检测**删除**的包
- ✅ 自动统计变更数量
- ✅ 发现变更时自动通知
- ✅ 支持自定义检测间隔

## 与单包监控的区别

| 功能 | 单包监控 (cydia.sgmodule) | 源全量监控 (本模块) |
|------|--------------------------|-------------------|
| 监控范围 | 指定的几个包 | 整个源的所有包 |
| 检测新增包 | ❌ | ✅ |
| 检测删除包 | ❌ | ✅ |
| 检测版本更新 | ✅ | ✅ |
| 检测版本降级 | ❌ | ✅ |
| 适用场景 | 关注特定插件 | 掌握源的全部动态 |
| 配置复杂度 | 需要指定每个包 | 只需填写源地址 |

**推荐使用场景：**
- 🎯 单包监控：如果你只关心几个特定插件的更新
- 🎯 源全量监控：如果你想掌握整个源的所有动态

## 安装使用

### 方法一：直接安装模块（推荐）

在Surge中添加模块：
```
https://raw.githubusercontent.com/xiyan-99/vpn/refs/heads/main/cydia-repo-monitor.sgmodule
```

### 方法二：本地配置

在Surge配置文件中添加：

```ini
[Panel]
cydia_repo_monitor = script-name=cydia_repo_monitor,update-interval=7200

[Script]
cydia_repo_monitor = type=generic,timeout=30,script-path=https://raw.githubusercontent.com/xiyan-99/vpn/refs/heads/main/cydia-repo-monitor.js,argument=REPOURL="源地址"
```

## 参数配置

### REPOURL（必填）

填写要监控的源地址，**只需要源地址，不需要包名**

**支持监控多个源**，支持多种分隔方式

**示例：**

监控单个源：
```
REPOURL = https://repo.chariz.com/
```

监控多个源（逗号分隔）：
```
REPOURL = https://repo.chariz.com/,https://havoc.app/,https://repo.packix.com/
```

监控多个源（一行一个，推荐）：
```
REPOURL = https://repo.chariz.com/
https://havoc.app/
https://repo.packix.com/
https://repo.twickd.com/
```

⚠️ **注意：** 
- 地址末尾的 `/` 可加可不加，脚本会自动处理
- 支持多种分隔方式：**逗号**、**换行**、**空格**、分号、竖线
- **一行一个**最方便，直接从其他地方复制粘贴即可
- Surge 会把换行符转换成空格，脚本会自动识别
- 支持同时监控任意数量的源

### UPDATEINTERVAL（可选）

自动更新间隔（秒），默认 7200（2小时）

```
UPDATEINTERVAL = 7200
```

**建议值：**
- `7200`（2小时）- 默认值，适合大多数场景
- `3600`（1小时）- 如果你想更频繁地检查
- `21600`（6小时）- 如果源更新不频繁

⚠️ 不建议设置太短，因为：
- 源的包通常不会频繁更新
- 下载整个 Packages 文件需要时间
- 过于频繁的请求可能给源服务器带来压力

### ALWAYSNOTIFY（可选）

是否每次都发送通知

- `false` - 默认，只在有变更时通知
- `true` - 每次检测都通知（包括无变更时）

```
ALWAYSNOTIFY = false
```

### MAXSHOW（可选）

面板最多显示的变更数量，默认 10

```
MAXSHOW = 10
```

如果变更的包很多，会显示：
```
• 包名1
• 包名2
... 还有 25 个
```

## 热门源列表

### Chariz
```
REPOURL = https://repo.chariz.com/
```
- 高质量付费插件源
- 包含 Substitute、Jellyfish 等

### Packix
```
REPOURL = https://repo.packix.com/
```
- 最大的第三方源之一
- 包含大量免费和付费插件

### Havoc
```
REPOURL = https://havoc.app/
```
- 新兴高质量源
- 包含 AltList、CCSupport 等

### Twickd
```
REPOURL = https://repo.twickd.com/
```
- 社区驱动的源
- 包含大量主题和插件

### Dynastic
```
REPOURL = https://repo.dynastic.co/
```
- 设计精美的插件源
- 包含 Prysm 等精品插件

### Bingner/Elucubratus
```
REPOURL = https://apt.bingner.com/
```
- unc0ver/Chimera 官方源
- 包含核心工具和依赖

## 配置示例

### 示例1：监控单个源（默认配置）

```
REPOURL = https://repo.chariz.com/
UPDATEINTERVAL = 7200
ALWAYSNOTIFY = false
MAXSHOW = 10
```

### 示例2：监控多个源（逗号分隔）

```
REPOURL = https://repo.chariz.com/,https://havoc.app/,https://repo.packix.com/
UPDATEINTERVAL = 7200
ALWAYSNOTIFY = false
MAXSHOW = 10
```

### 示例3：监控多个源（一行一个，推荐）

```
REPOURL = https://repo.chariz.com/
https://havoc.app/
https://repo.packix.com/
https://repo.twickd.com/
https://apt.bingner.com/
https://repo.dynastic.co/
UPDATEINTERVAL = 7200
ALWAYSNOTIFY = false
MAXSHOW = 10
```

### 示例4：监控多个源（每小时检查）

```
REPOURL = https://repo.chariz.com/
https://havoc.app/
https://repo.twickd.com/
https://apt.bingner.com/
UPDATEINTERVAL = 3600
ALWAYSNOTIFY = false
MAXSHOW = 15
```

### 示例5：监控单个源（总是通知）

```
REPOURL = https://havoc.app/
UPDATEINTERVAL = 7200
ALWAYSNOTIFY = true
MAXSHOW = 10
```

## 面板显示

### 单源 - 首次运行时：
```
✅ 已记录 1 个源
━━━━━━━━━━━━━━━━
📝 首次记录 1 个源:
  📦 Chariz: 247 个包

📦 总包数: 247 | 源数: 1

⏱️ 耗时: 3.2s | 📅 20:15
```

### 多源 - 首次运行时：
```
✅ 已记录 3 个源
━━━━━━━━━━━━━━━━
📝 首次记录 3 个源:
  📦 Chariz: 247 个包
  📦 Havoc: 183 个包
  📦 Packix: 1432 个包

📦 总包数: 1862 | 源数: 3

⏱️ 耗时: 8.5s | 📅 20:15
```

### 单源 - 有变更时：
```
🆕 发现 5 个变更
━━━━━━━━━━━━━━━━
📊 变更统计:
➕ 新增: 2
⬆️ 更新: 3

📦 Chariz (5个变更):
  ⬆️ Substitute: 2.3.5 → 2.3.6
  ⬆️ Jellyfish: 1.5.0 → 1.5.1
  ⬆️ NewTerm: 3.2 → 3.3

📦 总包数: 249 | 源数: 1

⏱️ 耗时: 4.1s | 📅 20:15
```

### 多源 - 有变更时：
```
🆕 发现 12 个变更
━━━━━━━━━━━━━━━━
📊 变更统计:
➕ 新增: 3
⬆️ 更新: 8
➖ 删除: 1

📦 Chariz (3个变更):
  ⬆️ Substitute: 2.3.5 → 2.3.6
  ⬆️ Jellyfish: 1.5.0 → 1.5.1
  ... 还有 1 个变更

📦 Havoc (5个变更):
  ⬆️ AltList: 1.0.8 → 1.0.9
  ➕ NewTweak 1.0
  ... 还有 3 个变更

📦 Packix (4个变更):
  ⬆️ AppList: 1.5.16 → 1.5.17
  ⬆️ PreferenceLoader: 2.2.5 → 2.2.6
  ... 还有 2 个变更

✅ 无变更源 (0个):

📦 总包数: 1867 | 源数: 3

⏱️ 耗时: 9.2s | 📅 20:15
```

### 单源 - 无变更时：
```
✅ 全部最新
━━━━━━━━━━━━━━━━
✅ 无变更源 (1个):
  📦 Chariz: 247 个包

📦 总包数: 247 | 源数: 1

⏱️ 耗时: 2.8s | 📅 20:15
```

### 多源 - 部分失败时：
```
🆕 发现 5 个变更
━━━━━━━━━━━━━━━━
📊 变更统计:
⬆️ 更新: 5

📦 Chariz (5个变更):
  ⬆️ Substitute: 2.3.5 → 2.3.6
  ... 还有 4 个变更

✅ 无变更源 (1个):
  📦 Havoc: 183 个包

❌ 获取失败 (1个):
  📦 自定义源

📦 总包数: 430 | 源数: 2

⏱️ 耗时: 7.3s | 📅 20:15
```

### 变更数量很多时：
```
🆕 Packix 有变更
━━━━━━━━━━━━━━━━
⬆️ 更新 25 个:
  • AppList
    1.5.16 → 1.5.17
  • PreferenceLoader
    2.2.5 → 2.2.6
  • RocketBootstrap
    1.0.9 → 1.0.10
  ... 还有 22 个

➕ 新增 5 个:
  • NewTweak1 1.0
  • NewTweak2 1.1
  • NewTweak3 2.0
  ... 还有 2 个

📦 当前总数: 1432

⏱️ 耗时: 6.5s | 📅 20:15
```

## 通知功能

### 通知时机

1. **首次运行** - 发送"监控已启动"通知
2. **发现变更** - 总是发送通知
3. **手动刷新** - 总是发送通知
4. **自动检测且无变更** - 不发送通知（除非开启ALWAYSNOTIFY）

### 通知内容示例

#### 单源 - 首次运行：
```
✅ 监控已启动 (1个源)
━━━━━━━━━━━━━━━━
📦 已记录 247 个包
🔔 将自动监控所有源的变更

📦 Chariz: 247个

⏱️ 检测耗时: 3.2秒
📅 2025/12/20 20:15
🔔 自动检测
```

#### 多源 - 首次运行：
```
✅ 监控已启动 (3个源)
━━━━━━━━━━━━━━━━
📦 已记录 1862 个包
🔔 将自动监控所有源的变更

📦 Chariz: 247个
📦 Havoc: 183个
📦 Packix: 1432个

⏱️ 检测耗时: 8.5秒
📅 2025/12/20 20:15
🔔 自动检测
```

#### 单源 - 发现变更：
```
🚀 源更新 (5个变更)
━━━━━━━━━━━━━━━━
📊 变更统计:
➕ 新增: 2
⬆️ 更新: 3

📦 Chariz: 5个变更

🔥 热门更新:
• Substitute: 2.3.5 → 2.3.6
• Jellyfish: 1.5.0 → 1.5.1
• NewTerm: 3.2 → 3.3

⏱️ 检测耗时: 4.1秒
📅 2025/12/20 20:15
🔔 自动检测
```

#### 多源 - 发现变更：
```
🚀 源更新 (12个变更)
━━━━━━━━━━━━━━━━
📊 变更统计:
➕ 新增: 3
⬆️ 更新: 8
➖ 删除: 1

📦 Chariz: 3个变更
📦 Havoc: 5个变更
📦 Packix: 4个变更

🔥 热门更新:
• Substitute: 2.3.5 → 2.3.6
• AltList: 1.0.8 → 1.0.9
• AppList: 1.5.16 → 1.5.17
• Jellyfish: 1.5.0 → 1.5.1
• PreferenceLoader: 2.2.5 → 2.2.6

⏱️ 检测耗时: 9.2秒
📅 2025/12/20 20:15
🔔 自动检测
```

#### 无变更（手动刷新时）：
```
✅ 检测完成 (3个源)
━━━━━━━━━━━━━━━━
📦 总包数: 1862
✨ 所有源均无变化

⏱️ 检测耗时: 8.1秒
📅 2025/12/20 20:15
🔄 手动刷新
```

### 点击通知

点击通知会跳转到对应的源（如果支持）。

## 工作原理

1. **下载源信息**
   - 从源服务器下载 `Packages` 文件（包含所有包的信息）
   - 下载 `Release` 文件（包含源的名称、描述等）
   - 检测 `CydiaIcon.png`（源的图标）
   - 解析出所有包的信息（包名、版本、描述等）

2. **保存到本地**
   - 将所有包的信息保存到 Surge 的持久化存储
   - 保存源的真实名称和图标URL

3. **定期对比**
   - 下次检查时，下载最新的 Packages 文件
   - 与上次保存的数据对比
   - 找出所有变化

4. **变更检测**
   - **新增**：新的包名出现
   - **更新**：相同包名，版本号变大
   - **降级**：相同包名，版本号变小
   - **删除**：旧包名消失

5. **通知和展示**
   - 在面板显示变更统计和详情
   - 使用源的真实名称（从 Release 文件获取）
   - 显示源的图标链接（如果可用）
   - 发送通知提醒用户

## 版本比较逻辑

脚本使用智能的版本比较算法：

```
2.3.5 < 2.3.6     ✅ 检测为更新
1.0 < 1.0.1       ✅ 检测为更新
2.0 > 1.9.9       ✅ 检测为更新
1.0-beta < 1.0    ✅ 检测为更新
```

支持常见的版本号格式：
- `1.0`
- `2.3.5`
- `1.0.1-beta`
- `3.2+debug1`

## 注意事项

### 1. 必须提供未压缩的 Packages 文件

脚本目前**不支持**解压 `.bz2` 或 `.gz` 格式。

大多数源都提供未压缩版本，脚本会自动尝试多个位置：
- `源地址/Packages`
- `源地址/dists/stable/main/binary-iphoneos-arm/Packages`
- `源地址/dists/stable/main/binary-iphoneos-arm64/Packages`

### 2. 首次运行不会通知变更

首次运行时，脚本会：
- 记录当前所有包的状态
- 显示"已记录"提示
- 不会显示任何"新增"

**从第二次运行开始**，才会对比并显示变更。

### 3. 数据存储

每个源的数据单独保存，存储格式：
```
repo_packages_https%3A%2F%2Frepo.chariz.com%2F
```

如果要清除历史记录，可以：
- 删除模块后重新安装
- 或等待 Surge 清理缓存

### 4. 超时时间

脚本设置了 30 秒的超时时间。

对于包数量很多的源（如 BigBoss），下载可能需要较长时间。

### 5. 只能监控一个源

每个模块实例只能监控**一个**源。

如果要监控多个源：
1. 复制模块文件
2. 修改文件名（如 `cydia-repo-monitor-chariz.sgmodule`）
3. 修改模块名称和面板名称
4. 分别安装

### 6. 网络要求

- 需要能访问越狱源服务器
- 建议使用稳定的网络环境
- 某些源在国内访问可能较慢

### 7. 检测频率建议

源的包通常不会频繁更新，建议：
- **活跃的源**（Chariz、Packix）：1-2小时
- **普通源**：2-4小时
- **不活跃的源**：6-12小时

## 常见问题

### Q: 为什么首次运行显示"已记录"而不是显示所有包？

A: 首次运行时没有历史数据可对比，所以脚本会先记录当前状态。从第二次运行开始，才能检测变更。

### Q: 可以同时监控多个源吗？

A: **可以！** 支持多种分隔方式：

**逗号分隔：**
```
REPOURL = https://repo.chariz.com/,https://havoc.app/,https://repo.packix.com/
```

**一行一个（推荐，最方便）：**
```
REPOURL = https://repo.chariz.com/
https://havoc.app/
https://repo.packix.com/
```

**💡 提示：** Surge 会把换行符转换成空格传递给脚本，但脚本会自动识别多个URL并正确分隔，所以你只管一行一个填写即可！

支持监控任意数量的源，它们会并行获取，效率很高。

### Q: 如何知道是哪些包更新了？

A: 在面板和通知中都会显示更新的包名和版本变化。如果更新的包很多，会显示前几个并注明"还有 X 个"。

### Q: 支持哪些源？

A: 理论上支持所有提供标准 Packages 文件的 Cydia/Sileo 源。前提是源提供**未压缩**的 Packages 文件。

### Q: 为什么有些源检测失败？

A: 可能的原因：
1. **源使用了压缩格式**（.bz2/.gz）而没有提供未压缩版本
2. **源的目录结构不标准** - 脚本会尝试多个常见路径
3. **网络问题** - 某些源可能被屏蔽或网络不稳定
4. **源服务器暂时不可用** - 稍后重试
5. **GitHub Pages 等静态托管** - 脚本已自动使用多种请求方式

**脚本已实现的容错机制：**
- ✅ 自动尝试 `fetch` 和 `$httpClient` 两种请求方式
- ✅ 使用标准浏览器 User-Agent 提高兼容性
- ✅ 尝试多个可能的 Packages 文件路径
- ✅ 30秒超时时间，适应慢速源
- ✅ 详细的错误日志，方便排查问题

**排查方法：**
1. 查看 Surge 日志，找到详细错误信息
2. 在浏览器中访问 `源地址/Packages` 确认文件存在
3. 如果是 GitHub Pages，确保仓库和文件都是公开的
4. 检查文件是否为压缩格式（.bz2/.gz）

### Q: 数据存储在哪里？

A: 存储在 Surge 的持久化存储中（`$persistentStore`），每个源的数据独立保存。

### Q: 降级的包是什么意思？

A: 某个包的版本号从高变低（如 2.0 → 1.9），这种情况比较罕见，通常是：
- 源维护者发现新版本有问题，回退到旧版本
- 源的数据库出现错误

### Q: 通知显示"还有 X 个"，如何查看完整列表？

A: 可以：
1. 在 Surge 面板中查看（显示更多）
2. 调整 `MAXSHOW` 参数增加显示数量
3. 查看 Surge 日志了解详细信息

### Q: 源有几百个包，会不会很慢？

A: 下载和解析时间取决于：
- Packages 文件的大小
- 网络速度
- 源服务器的响应速度

通常 2-10 秒内可以完成。如果超过 20 秒会超时。

### Q: 删除的包能恢复吗？

A: 脚本只负责检测和通知，不会保存完整的包内容。如果包被删除了，你可以：
1. 查看通知/日志，了解是哪个包
2. 去其他源查找该包
3. 联系源维护者询问

### Q: 监控多个源会不会很慢？

A: 不会！脚本使用**并行请求**，同时获取所有源的数据。监控3个源和监控1个源的时间差不多，只要网络状况良好。

### Q: 监控多个源时，通知会分开发送吗？

A: 不会。所有源的变更会合并到**一条通知**中，清晰显示每个源的变更情况，不会刷屏。

## 调试方法

查看 Surge 日志可以看到详细信息：

```
🔍 接收到的完整参数: REPOURL="https://repo.chariz.com/"
📋 监控源: https://repo.chariz.com/
🔍 开始获取源: Chariz
🔍 尝试: https://repo.chariz.com/Packages
✅ 成功获取 Packages 文件，大小: 125.3 KB
📦 解析出 247 个包

📊 对比变更: 旧=245 vs 新=247

📈 变更统计: 新增=2, 更新=3, 降级=0, 删除=0

========================================
Chariz 源监控完成 (4.1s)
📦 当前包数: 247
✨ 发现变更:
  ➕ 新增: 2 个
  ⬆️ 更新: 3 个
========================================
```

## 高级技巧

### 技巧1：监控多个源（推荐一行一个）

**最推荐的方式**：一行一个源地址，方便复制粘贴
```
REPOURL = https://repo.chariz.com/
https://havoc.app/
https://repo.packix.com/
https://repo.twickd.com/
https://apt.bingner.com/
https://repo.dynastic.co/
```

也可以用逗号分隔：
```
REPOURL = https://repo.chariz.com/,https://havoc.app/,https://repo.packix.com/
```

脚本会自动并行获取所有源的数据，并在一个面板/通知中展示所有变更！

**优势：** 从源列表复制粘贴时不需要手动添加逗号，直接复制即可！

### 技巧2：根据源的活跃度调整检测间隔

- **活跃源**（如 Chariz、Packix）：1-2小时
- **中等源**（如 Havoc、Twickd）：3-4小时  
- **不活跃源**（如个人源）：6-12小时

### 技巧3：配合单包监控使用

对于特别关注的包：
- 使用**单包监控**（cydia.sgmodule）- 更快、更精准
- 对于感兴趣的源：使用**源全量监控**（本模块）- 不会错过任何新插件

### 技巧4：查看完整日志

在 Surge 中查看脚本执行日志，可以看到：
- 所有变更的包名和版本
- 详细的错误信息
- 网络请求的详情

## 更新日志

### v1.0
- 初始版本
- 支持监控整个源的所有包变更
- 检测新增、更新、降级、删除
- 智能版本比较
- 面板展示和通知推送

## 作者信息

- **作者**: 夕颜
- **微信**: 1418581664
- **主页**: https://iosxy.xin
- **GitHub**: https://github.com/xiyan-99/vpn

## 许可证

MIT License

---

**享受完整的源监控体验！🎉**

